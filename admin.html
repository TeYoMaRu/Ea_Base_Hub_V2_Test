<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Admin | ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</title>

<!-- ‡πÇ‡∏´‡∏•‡∏î Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
 <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- CSS ‡πÅ‡∏¢‡∏Å‡πÑ‡∏ü‡∏•‡πå -->
<link rel="stylesheet" href="css/admin-base.css">
<link rel="stylesheet" href="css/admin-users.css">

</head>

<body>

<header class="topbar">
  <div class="brand">üåø EABaseHub | Admin</div>
  <button onclick="logout()" class="btn">Logout</button>
</header>

<main class="container">

  <div class="admin-header">
    <h2 class="admin-title">
      <span class="material-symbols-outlined admin-title-icon">admin_panel_settings</span>
      ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
    </h2>
    <button class="btn-back" onclick="goHome()">
      <span class="material-symbols-outlined btn-back-icon">arrow_back</span>
      ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
    </button>
  </div>

   <!-- ==================== TABS NAVIGATION ==================== -->
  <!-- ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π 3 Tab -->
  <div class="admin-tabs">

    <!-- Tab 1: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô -->
    <button class="admin-tab active" onclick="showTab('users')">
      <span class="material-symbols-outlined">people</span>
      ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    </button>

    

    <!-- Tab 2: Sales -->
    <button class="admin-tab" onclick="showTab('sales')">
      <span class="material-symbols-outlined">badge</span>
      Sales
    </button>
    

    <!-- Tab 3: ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ -->
    <a class="admin-tab" href="admin-shops.html">
  <span class="material-symbols-outlined">store</span>
  ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
</a>


  
  </div>

  <!-- ==================== TAB 1: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ==================== -->
  <!-- 
    ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    - ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö Sales
    - ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á User ‡∏Å‡∏±‡∏ö Sales
  -->
  <div id="tabUsers" class="tab-content active">

    <!-- ‡∏õ‡∏∏‡πà‡∏° Refresh -->
    <button class="btn-refresh" onclick="loadUsers()">
      <span class="material-symbols-outlined">refresh</span>
      ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
    </button>
  

    <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    <div class="search-box">
      <input 
        type="text" 
        id="searchUser" 
        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ email, username..." 
        oninput="filterUsers()"
      >
    </div> -->

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
    <div class="admin-table-card">
      <div class="admin-table-responsive">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Email</th>
              <th>Username</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</th>
              <th>Role</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              <!-- <th>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th> -->
            </tr>
          </thead>
          <!-- tbody ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å JS -->
    <tbody id="userTable"></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- ==================== TAB 2: Sales ==================== -->
  <!-- 
    ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Sales
    - ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sales
    - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
  -->
  <div id="tabSales" class="tab-content">

    

    <!-- ‡∏õ‡∏∏‡πà‡∏° Refresh -->
    <button class="btn-refresh" onclick="loadSales()">
      <span class="material-symbols-outlined">refresh</span>
      ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
    </button>

    <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
    <div class="search-box">
      <input 
        type="text" 
        id="searchSales" 
        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏£‡∏´‡∏±‡∏™, ‡∏ä‡∏∑‡πà‡∏≠ Sales..." 
        oninput="filterSales()"
      >
    </div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Sales -->
    <div class="admin-table-card">
      <div class="admin-table-responsive">
        <table class="admin-table">
          <thead>
            <tr>
              <th>‡∏£‡∏´‡∏±‡∏™</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠ Sales</th>
              <th>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="salesTableContainer">
            <!-- Loading State -->
            <tr>
              <td colspan="5">
                <div class="loading-state">
                  <span class="material-symbols-outlined loading-spinner">progress_activity</span>
                  <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

 <!-- ==================== TAB 3: ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ==================== -->
  <!-- 
    ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ Sales
    - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sales
    - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ
  -->
  <div id="tabPermissions" class="tab-content">

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sales -->
    <div class="form-group">
      <label>
        <span class="material-symbols-outlined label-icon">badge</span>
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sales
      </label>
      <select id="selectSaleForPerm" onchange="loadSaleShops()">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sales --</option>
        <!-- Options ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
      </select>
    </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ - Content ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
    <div id="permissionsContainer">
      <!-- renderPermissionsCheckboxes() ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á content ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
      <div class="empty-state">
        <span class="material-symbols-outlined">store</span>
        <div class="empty-state-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sales ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</div>
      </div>
    </div>

  </div>

</div>

<!-- Background Overlay -->
<div class="modal-bg" id="linkModalBg" onclick="closeLinkModal()"></div>

<!-- Modal Box -->
<div class="modal-box" id="linkModalBox">

  <!-- Header -->
  <div class="modal-head">
    <h3>
      <span class="material-symbols-outlined">link</span>
      ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á User ‡∏Å‡∏±‡∏ö Sales
    </h3>
    <button class="modal-close" onclick="closeLinkModal()">&times;</button>
  </div>

  <!-- Body -->
  <div class="modal-body">

    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
    <div class="user-info-box">
      <div class="user-info-row">
        <span class="user-info-label">Email:</span>
        <span class="user-info-value" id="linkUserEmail">-</span>
      </div>
      <div class="user-info-row">
        <span class="user-info-label">Username:</span>
        <span class="user-info-value" id="linkUserName">-</span>
      </div>
      <div class="user-info-row">
        <span class="user-info-label">‡∏ä‡∏∑‡πà‡∏≠:</span>
        <span class="user-info-value" id="linkUserDisplay">-</span>
      </div>
    </div>

    <!-- Dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sales -->
    <div class="form-group">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sales ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á</label>
      <select id="linkSalesSelect">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sales --</option>
        <!-- Options ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
      </select>
    </div>

  </div>

  <!-- Footer -->
  <div class="modal-foot">
    <button class="btn-modal-cancel" onclick="closeLinkModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    <button class="btn-modal-save" onclick="saveLinkUser()" id="btnSaveLink">
      <span class="material-symbols-outlined">save</span>
      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    </button>
  </div>

</div>

<!-- =====================================================
     MODAL: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á Sales
     =====================================================
     Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà Sales ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
     - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sales ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
     - Checkbox ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
     ===================================================== -->

<!-- Background Overlay -->
<div class="modal-bg" id="shopModalBg" onclick="closeShopModal()"></div>

<!-- Modal Box -->
<div class="modal-box" id="shopModalBox">

  <!-- Header -->
  <div class="modal-head">
    <h3>
      <span class="material-symbols-outlined">store</span>
      ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: <span id="shopModalSalesName">-</span>
    </h3>
    <button class="modal-close" onclick="closeShopModal()">&times;</button>
  </div>

  <!-- Body -->
  <div class="modal-body">

    <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ -->
    <div class="search-box">
      <input 
        type="text" 
        id="searchModalShops" 
        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤..." 
        oninput="filterModalShops()"
      >
    </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Checkbox ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ -->
    <div class="checkbox-list" id="shopModalList">
      <!-- Checkboxes ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
    </div>

  </div>

  <!-- Footer -->
  <div class="modal-foot">
    <button class="btn-modal-cancel" onclick="closeShopModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    <button class="btn-modal-save" onclick="saveShopModal()" id="btnSaveShop">
      <span class="material-symbols-outlined">save</span>
      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    </button>
  </div>

</div>

  

  
    </thead>

    <!-- tbody ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å JS -->
    <tbody id="userTable"></tbody>
  </table>

</main>

<script>
// ===============================
// 1Ô∏è‚É£ Supabase Config
// ===============================
const supabaseClient = supabase.createClient(
  "https://vhazgytcfvjhhikiqpwm.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZoYXpneXRjZnZqaGhpa2lxcHdtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NjA1MjgsImV4cCI6MjA4NjIzNjUyOH0.wHHUPop0xMrUgX6X8Jkk-fahVfIMW-iYx4NT0zg5lxM"

);

// ===============================
// 2Ô∏è‚É£ Protect Admin Page
// ===============================
async function protectAdmin() {

  const { data: { user } } =
    await supabaseClient.auth.getUser();

  if (!user) {
    window.location.href = "login.html";
    return;
  }

  // ‡πÄ‡∏ä‡πá‡∏Ñ role
  const { data: profile } =
    await supabaseClient
      .from("profiles")
      .select("role")
      .eq("id", user.id)
      .single();

  if (profile.role !== "admin") {
    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
    window.location.href = "index.html";
  }
}

// ===============================
// 3Ô∏è‚É£ Load Users
// ===============================
async function loadUsers() {

  const { data, error } =
    await supabaseClient
      .from("profiles")
      .select("*")
      .order("created_at", { ascending: false });

  if (error) {
    console.error(error);
    return;
  }

  const table = document.getElementById("userTable");
  table.innerHTML = "";

  data.forEach(user => {

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${user.email}</td>
      <td>${user.username}</td>
      <td>${user.display_name || "-"}</td>
      <td>${user.role}</td>
      <td>${user.status || "Active"}</td>
      <td>
        <a href="adminUserEdit.html?id=${user.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
      </td>
    `;

    table.appendChild(tr);
  });
}

// ===============================
// 4Ô∏è‚É£ Logout
// ===============================
async function logout() {
  await supabaseClient.auth.signOut();
  window.location.href = "login.html";
}

// ===============================
// 5Ô∏è‚É£ Init
// ===============================
(async () => {
  await protectAdmin();
  await loadUsers();
})();
</script>

</body>
</html>
