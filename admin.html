<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Admin | ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</title>

<!-- ‡πÇ‡∏´‡∏•‡∏î Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
 <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- CSS ‡πÅ‡∏¢‡∏Å‡πÑ‡∏ü‡∏•‡πå -->
<link rel="stylesheet" href="css/admin-base.css">
<link rel="stylesheet" href="css/admin-users.css">

</head>

<body>

<header class="topbar">
  <div class="brand">üåø EABaseHub | Admin</div>
  <button onclick="logout()" class="btn">Logout</button>
</header>

<main class="container">

  <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>

  <div class="tabs">
    <a class="tab" href="admin.html">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
     <a class="btn-sm edit"
           href="admin-shops.html?sale=${sale.id}">
           ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
        </a>
    <a class="tab active" href="#">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</a>
  </div>

  <table>
    <thead>
      <tr>
        <th>Email</th>
        <th>Username</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</th>
        <th>Role</th>
        <th>Status</th>
        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>
    </thead>

    <!-- tbody ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å JS -->
    <tbody id="userTable"></tbody>
  </table>

</main>

<script>
// ===============================
// 1Ô∏è‚É£ Supabase Config
// ===============================
const supabaseClient = supabase.createClient(
  "https://vhazgytcfvjhhikiqpwm.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZoYXpneXRjZnZqaGhpa2lxcHdtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NjA1MjgsImV4cCI6MjA4NjIzNjUyOH0.wHHUPop0xMrUgX6X8Jkk-fahVfIMW-iYx4NT0zg5lxM"

);

// ===============================
// 2Ô∏è‚É£ Protect Admin Page
// ===============================
async function protectAdmin() {

  const { data: { user } } =
    await supabaseClient.auth.getUser();

  if (!user) {
    window.location.href = "login.html";
    return;
  }

  // ‡πÄ‡∏ä‡πá‡∏Ñ role
  const { data: profile } =
    await supabaseClient
      .from("profiles")
      .select("role")
      .eq("id", user.id)
      .single();

  if (profile.role !== "admin") {
    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
    window.location.href = "index.html";
  }
}

// ===============================
// 3Ô∏è‚É£ Load Users
// ===============================
async function loadUsers() {

  const { data, error } =
    await supabaseClient
      .from("profiles")
      .select("*")
      .order("created_at", { ascending: false });

  if (error) {
    console.error(error);
    return;
  }

  const table = document.getElementById("userTable");
  table.innerHTML = "";

  data.forEach(user => {

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${user.email}</td>
      <td>${user.username}</td>
      <td>${user.display_name || "-"}</td>
      <td>${user.role}</td>
      <td>${user.status || "Active"}</td>
      <td>
        <a href="adminUserEdit.html?id=${user.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
      </td>
    `;

    table.appendChild(tr);
  });
}

// ===============================
// 4Ô∏è‚É£ Logout
// ===============================
async function logout() {
  await supabaseClient.auth.signOut();
  window.location.href = "login.html";
}

// ===============================
// 5Ô∏è‚É£ Init
// ===============================
(async () => {
  await protectAdmin();
  await loadUsers();
})();
</script>

</body>
</html>
